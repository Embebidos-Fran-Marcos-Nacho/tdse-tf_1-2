\documentclass[12pt,a4paper]{article}

\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[spanish]{babel}
\usepackage{lmodern}
\usepackage{geometry}
\geometry{margin=2.5cm}

\usepackage{graphicx}
\usepackage{float}
\usepackage[unicode,hidelinks]{hyperref}
\usepackage{url}
\usepackage{tabularx}
\usepackage{booktabs}
\usepackage{enumitem}
\usepackage{amsmath}

\addto\captionsspanish{\renewcommand{\contentsname}{√çndice General}}

\setlist[itemize]{noitemsep, topsep=2pt}
\setlist[enumerate]{noitemsep, topsep=2pt}

\title{Dimmer + Switch (Ventilador \& Luces)\\Control de ventilador y luces de l√≠nea (220 V) desde pared y v√≠a Bluetooth}
\author{Ignacio Ezequiel Cavicchioli \and Francisco Javier Moya}
\date{25/01/2026}

\begin{document}
\maketitle
\tableofcontents
\newpage
\section{Dimmer + Switch (Ventilador \& Luces)}
Control de ventilador y luces de l√≠nea (220 V) desde pared y v√≠a Bluetooth

\textbackslash{}begin\{center\}
\textbackslash{}begin\{center\}
\textbackslash{}includegraphics[width=0.6\textbackslash{}linewidth]\{https://github.com/Embebidos-Fran-Marcos-Nacho/tdse-tf\textbackslash{}\_1-2/blob/08290a7a62c8a7d3fcd22fc57871dafbbf35ab15/logo-fiuba.png\}
\textbackslash{}end\{center\}
\textbf{UNIVERSIDAD DE BUENOS AIRES\textbackslash{}\}\textbackslash{}\textbackslash{}\textbf{Facultad de Ingenier√≠a\textbackslash{}\}\textbackslash{}\textbackslash{}\textbf{TA134 ‚Äì Sistemas Embebidos\textbackslash{}\}\textbackslash{}\textbackslash{}Curso 1 ‚Äì Grupo 2
\textbackslash{}end\{center\}

\subsection{Autores}
\begin{itemize}
\item Ignacio Ezequiel Cavicchioli ‚Äî Legajo 109428
\item Francisco Javier Moya ‚Äî Legajo 109899
\end{itemize}

\textbf{Fecha:\} 25/01/2026
\textbf{Cuatrimestre de cursada:\} 2do cuatrimestre 2025

\textit{Trabajo realizado entre diciembre 2025 y febrero 2026.\}

\hrulefill


\subsection{Resumen}

Se desarroll√≥ un sistema embebido para control de luz y ventilador de red (220 VAC), con:
\begin{itemize}
\item Control local por pulsadores y potenci√≥metro.
\item Telemetr√≠a por Bluetooth con m√≥dulo HC-06.
\item Sincronizaci√≥n por cruce por cero.
\item Almacenamiento persistente en flash interna del STM32.
\end{itemize}

El hardware se implement√≥ en dos placas (shield de control y placa de potencia/dimmer), evitando protoboard y cableado Dupont para la integraci√≥n final. La √∫nica excepci√≥n es el uso de leds en paralelo con los bulbos de luz requeridos en las pruebas de potencia; la tensi√≥n no es suficiente como para encenderlos, por lo que se usaron leds en paralelo como indicadores.
El firmware se implement√≥ en una NUCLEO-F103RB con arquitectura modular de tareas y m√°quina de estados para modos de inicializaci√≥n, operaci√≥n normal y falla segura.

Esta memoria documenta los requisitos, el dise√±o de hardware y firmware, los ensayos realizados y el estado final de cumplimiento.

\hrulefill

\subsection{Registro de versiones}

\begin{table}[h]
\centering
\begin{tabularx}{\linewidth}{clX}
\toprule
Revisi√≥n & Cambios realizados & Fecha \\
\midrule
1.0 & Reescritura integral de la memoria, alineada a pautas de entrega final & 17/02/2026 \\
1.1 & Completar con mediciones de consumo, WCET y factor de uso CPU & 17/02/2026 \\
1.2 & Completar con permalinks definitivos de im√°genes y link de video & 17/02/2026 \\
1.2 & Entrega N¬∞1 & 17/02/2026 \\
1.3 & Correcciones Entrega N¬∞2 & 19/02/2026 \\
\bottomrule
\end{tabularx}
\end{table}

\hrulefill

\section{Introducci√≥n general}

\subsection{An√°lisis de necesidad y objetivo}

El proyecto busca resolver una necesidad concreta de control de cargas de 220 VAC (luz y ventilador) desde una interfaz de pared, agregando telemetr√≠a inal√°mbrica sin depender de la red Wi-Fi dom√©stica.

Objetivos principales:
\begin{itemize}
\item Implementar un prototipo funcional y seguro de control de luz/ventilador.
\item Usar una arquitectura modular en STM32.
\item Tener persistencia de estado en la memoria flash.
\end{itemize}

\subsection{Productos comparables}

Se analizaron dos tipos de soluciones comerciales disponibles en la Argentina:

\begin{enumerate}
\item \textbf{Ventilador con control remoto IR/RF\}
Existen en el mercado local ventiladores controlados por control remoto dedicado.
Este tipo de control funciona correctamente, pero presenta limitaciones importantes:
\end{enumerate}
\begin{itemize}
\item Solo tiene control remoto, no tiene control fijo.
\item No ofrece conectividad con el celular.
\item No guarda configuraciones ni estados previos del ventilador.
\item Solo tiene 3 velocidades de ventilador.
\end{itemize}


\begin{enumerate}
\item \textbf{Controladores disponibles internacionalmente (Amazon)\}
En el mercado internacional existen productos m√°s avanzados, capaces de integrar control de luces y ventilador, conectividad Wi-Fi, y aplicaciones m√≥viles.
Sin embargo:
\end{enumerate}
\begin{itemize}
\item Tienen costos significativamente m√°s altos o no cuentan con disponibilidad local inmediata.
\item En general los que usan wi-fi no tienen tecla y representan una amenaza a la seguridad de la red dom√©stica del usuario.
\end{itemize}

Ante la gran brecha de funcionalidad entre estos dos dispositivos, se opt√≥ por utilizar una interfaz local combinada con un m√≥dulo Bluetooth cl√°sico HC-06. Esta soluci√≥n h√≠brida prioriza la simplicidad de integraci√≥n, combinando la comodidad del control de pared con la telemetr√≠a inal√°mbrica por medio de bleutooth. La siguiente secci√≥n brinda m√°s detalles sobre estas decisiones de dise√±o.

\subsection{Justificaci√≥n del enfoque t√©cnico}

Se eligi√≥ Bluetooth cl√°sico (HC-06) por:
\begin{itemize}
\item Menor complejidad de despliegue que Wi-Fi.
\item Facilidad de integraci√≥n con la app realizada en MIT App Inventor.
\item Disponibilidad de herramientas de depuraci√≥n por UART.
\end{itemize}

Se mantuvo un alcance acotado para cumplir entrega:
\begin{itemize}
\item La app m√≥vil recibe telemetr√≠a binaria de 2 bytes.
\item El control principal de actuadores se mantiene en interfaz local.
\end{itemize}

En una futura versi√≥n, el producto deber√≠a permitir el control por medio de la conexi√≥n inal√°mbrica, equiparandolo a la soluci√≥n comercial mostrada m√°s completa.

\subsection{Alcance y limitaciones}

Alcance implementado:
\begin{itemize}
\item Encendido/apagado de luz por botones f√≠sicos.
\item Ajuste de velocidad del ventilador por potenci√≥metro.
\item Env√≠o de telemetr√≠a por HC-06 (2 bytes).
\item Estado de falla segura y persistencia b√°sica en flash.
\end{itemize}

Fuera de alcance actual:
\begin{itemize}
\item Control remoto completo de actuadores desde app.
\end{itemize}

\hrulefill

\section{Introducci√≥n espec√≠fica}

\subsection{Requisitos (versi√≥n final del informe de avances)}

\begin{table}[h]
\centering
\begin{tabularx}{\linewidth}{llX}
\toprule
Grupo & ID & Descripci√≥n \\
\midrule
Control & 1.1 & El sistema permitir√° encender y apagar las luces mediante un bot√≥n f√≠sico. \\
 & 1.2 & El sistema permitir√° ajustar la velocidad del ventilador mediante un potenci√≥metro. \\
 & 1.3 & El sistema permitir√° ver el estado del ventilador y las luces v√≠a Bluetooth. \\
Bluetooth & 2.1 & El sistema contar√° con un DIP switch para habilitar o deshabilitar el Bluetooth. \\
 & 2.2 & El DIP switch permitir√° seleccionar configuraciones o canales del m√≥dulo Bluetooth. \\
Indicadores & 3.1 & El sistema contar√° con LEDs que indiquen el estado del Bluetooth. \\
 & 3.2 & El sistema contar√° con un buzzer para se√±alizar eventos del sistema. \\
Memoria & 4.1 & El sistema deber√° guardar en memoria flash el √∫ltimo valor de PWM utilizado. \\
 & 4.2 & El sistema deber√° restaurar autom√°ticamente el √∫ltimo valor guardado al encender. \\
Seguridad el√©ctrica & 5.1 & El sistema deber√° operar de forma segura sobre cargas de 220 VAC. \\
Aplicaci√≥n m√≥vil & 6.1 & La aplicaci√≥n dar√° informaci√≥n sobre los estados disponibles, que incluyen la velocidad del ventilador y el estado de luces. \\
 & 6.2 & El sistema deber√° evitar conflictos entre el control f√≠sico y la comunicaci√≥n Bluetooth, incluyendo conflictos de timings. \\
\bottomrule
\end{tabularx}
\end{table}

\subsection{Casos de uso}

\subsubsection{Caso de uso 1: Control local de luz}

\begin{table}[h]
\centering
\begin{tabular}{ll}
\toprule
Elemento & Definici√≥n \\
\midrule
Disparador & Pulsaci√≥n de bot√≥n ON (\texttt{PC12\}) o OFF (\texttt{PC9\}). \\
Precondiciones & Sistema en modo normal, hardware operativo. \\
Flujo b√°sico & Debounce de bot√≥n -> evento -> actualizaci√≥n de estado de luz -> actualizaci√≥n de salida TRIAC -> solicitud de guardado en flash -> telemetr√≠a BT de cambio. \\
Alternativas & Si falla persistencia y modo estricto activo: transici√≥n a \texttt{FAULT\}. \\
\bottomrule
\end{tabular}
\end{table}

\subsubsection{Caso de uso 2: Ajuste local de ventilador}

\begin{table}[h]
\centering
\begin{tabular}{ll}
\toprule
Elemento & Definici√≥n \\
\midrule
Disparador & Cambio en potenci√≥metro (\texttt{PA0\}). \\
Precondiciones & ADC operativo, sistema en modo normal. \\
Flujo b√°sico & Muestreo ADC -> mapeo a porcentaje -> c√°lculo de \texttt{fan\textbackslash{}\_delay\textbackslash{}\_us\} -> actualizaci√≥n de temporizaci√≥n de disparo TRIAC. \\
Alternativas & Si potenci√≥metro fuera de rango calibrado: saturaci√≥n a l√≠mites definidos. \\
\bottomrule
\end{tabular}
\end{table}

\subsubsection{Caso de uso 3: Telemetr√≠a Bluetooth hacia app}

\begin{table}[h]
\centering
\begin{tabular}{ll}
\toprule
Elemento & Definici√≥n \\
\midrule
Disparador & Cambio de estado de luz o de porcentaje del potenci√≥metro. \\
Precondiciones & BT habilitado por DIP1, m√≥dulo HC-06 conectado. \\
Flujo b√°sico & Firmware arma trama binaria de 2 bytes y transmite por USART1 para que la app informe el estado del sistema. \\
Alternativas & Si BT deshabilitado, no se transmite. \\
\bottomrule
\end{tabular}
\end{table}

\subsubsection{Caso de uso 4: Recuperaci√≥n tras falla}

\begin{table}[h]
\centering
\begin{tabular}{ll}
\toprule
Elemento & Definici√≥n \\
\midrule
Disparador & Error de inicializaci√≥n o forzado de \texttt{FAULT\} por DIP4 (\texttt{PA4\}). \\
Precondiciones & Sistema energizado. \\
Flujo b√°sico & Corte de salidas de potencia, alarma visual/sonora seg√∫n DIP, reintento de inicializaci√≥n luego de timeout. \\
Alternativas & Si DIP4 vuelve a 0, salida de \texttt{FAULT\} y retorno a \texttt{NORMAL\}. \\
\bottomrule
\end{tabular}
\end{table}

Nota de trazabilidad de alcance:
\begin{itemize}
\item El informe de avances redefini√≥ el alcance Bluetooth para visualizaci√≥n de estado (sin control remoto completo de actuadores).
\item Los casos de uso y la app se documentan en consecuencia: recepci√≥n de telemetr√≠a y presentaci√≥n de estado.
\end{itemize}

\subsection{Descripci√≥n de m√≥dulos principales}

\subsubsection{2.3.1 M√≥dulo de control (NUCLEO-F103RB)}
\begin{itemize}
\item Ejecuta scheduler cooperativo con tick de 1 ms.
\item Corre tres tareas: \texttt{task\textbackslash{}\_adc\}, \texttt{task\textbackslash{}\_system\}, \texttt{task\textbackslash{}\_pwm\}.
\end{itemize}

\subsubsection{2.3.2 M√≥dulo de potencia (dimmer)}
\begin{itemize}
\item Dos canales de disparo TRIAC (luz y ventilador).
\item Optoacople de disparo y red de protecci√≥n.
\end{itemize}

\subsubsection{2.3.3 M√≥dulo de detecci√≥n de cruce por cero (ZCD)}
\begin{itemize}
\item Entrada AC aislada y acondicionada a se√±al digital.
\item Entrada de interrupci√≥n por \texttt{PC2\} (EXTI).
\end{itemize}

\subsubsection{2.3.4 M√≥dulo Bluetooth (HC-06)}
\begin{itemize}
\item Interfaz UART transparente en \texttt{PA9/PA10\}.
\item Configuraci√≥n AT realizada con interfaz auxiliar USB-UART (Arduino).
\end{itemize}

\subsubsection{2.3.5 Aplicaci√≥n m√≥vil (MIT App Inventor)}
\begin{itemize}
\item Lectura de trama binaria de 2 bytes.
\item Visualizaci√≥n del porcentaje y estado de luz.
\end{itemize}

\hrulefill

\section{Dise√±o e implementaci√≥n}

\subsection{Arquitectura general}

El sistema se organiza en dos dominios:
\begin{itemize}
\item Dominio l√≥gico de 3.3 V (STM32 + entradas + comunicaciones).
\item Dominio de potencia AC (TRIAC + ZCD + protecciones).
\end{itemize}

\textbf{Figura 3.1 - Diagrama en bloques general\}
\begin{figure}[H]
\centering
\includegraphics[width=0.85\linewidth]{https://github.com/Embebidos-Fran-Marcos-Nacho/tdse-tf\_1-2/blob/663d795450e29c452e59a7ecae6f23108cb3e22d/Memoria\%20t\%C3\%A9cnica/imgs/diagrama\%20en\%20bloques.jpg}
\caption{Imagen}

\end{figure}

\textit{Ep√≠grafe: Diagrama de bloques general.\}



\subsection{Dise√±o de hardware}

\subsubsection{3.2.1 Criterio de interconexi√≥n y montaje}

Se trabaj√≥ con placas y conexiones soldadas para la integraci√≥n funcional final (sin protoboard ni cables Dupont en el montaje objetivo), en l√≠nea con las pautas de entrega.

Se usaron dos placas:
\begin{itemize}
\item placa shield para interfaz y conexi√≥n con NUCLEO.
\item placa dimmer para potencia, ZCD y protecciones.
\end{itemize}

\subsubsection{Etapa de conversi√≥n de niveles}

\textbf{Figura 3.2 - Esquem√°tico del conversor de niveles\}
\begin{figure}[H]
\centering
\includegraphics[width=0.85\linewidth]{https://github.com/Embebidos-Fran-Marcos-Nacho/tdse-tf\_1-2/blob/c2fc7354b11ef4655cebe90b4b788acc5695045a/Memoria\%20t\%C3\%A9cnica/imgs/esquema\%20niveles.png}
\caption{Imagen}

\end{figure}
\textit{Ep√≠grafe: Esquem√°tico del conversor de niveles.\}

Se requiri√≥ para unir la placa F103RB (3.3 V) con la placa dise√±ada (5 V).

\subsubsection{Etapa de Triacs}

\textbf{Figura 3.3 - Esquem√°tico de driver de TRIAC\}
\begin{figure}[H]
\centering
\includegraphics[width=0.85\linewidth]{https://github.com/Embebidos-Fran-Marcos-Nacho/tdse-tf\_1-2/blob/c2fc7354b11ef4655cebe90b4b788acc5695045a/Memoria\%20t\%C3\%A9cnica/imgs/esquem\%20triac.png}
\caption{Imagen}

\end{figure}
\textit{Ep√≠grafe: Esquem√°tico de driver de TRIAC.\}

Dise√±o tomado de las notas de aplicaci√≥n que se encuentran en este mismo repositorio en la secci√≥n de hardware.

\subsubsection{3.2.2 Etapa ZCD (detecci√≥n de cruce por cero)}

La etapa de ZCD fue validada progresivamente en banco antes de integrar potencia. Se observ√≥ que:
\begin{itemize}
\item la salida detectada requiere compensaci√≥n temporal aproximada de 500 us para ubicar el cruce real.
\item las simulaciones resultaron consistentes con la tendencia medida.
\end{itemize}

\textbf{Figura 3.4 - Esquem√°tico del ZCD\}

\begin{figure}[H]
\centering
\includegraphics[width=0.85\linewidth]{https://github.com/Embebidos-Fran-Marcos-Nacho/tdse-tf\_1-2/blob/c2fc7354b11ef4655cebe90b4b788acc5695045a/Memoria\%20t\%C3\%A9cnica/imgs/esquematico\%20ZCD.png}
\caption{Imagen}

\end{figure}
\textit{Ep√≠grafe: Esquem√°tico del ZCD.\}



\textbf{Figura 3.5 - Banco inicial de pruebas ZCD\}
\begin{figure}[H]
\centering
\includegraphics[width=0.85\linewidth]{https://github.com/Embebidos-Fran-Marcos-Nacho/tdse-tf\_1-2/blob/663d795450e29c452e59a7ecae6f23108cb3e22d/Memoria\%20t\%C3\%A9cnica/cosas\%20e\%20imagenes\%20para\%20memoria\%20t\%C3\%A9cnica\%20-\%20hardware/ZCD/banco\%20de\%20trabajo\%20inicial.jpeg}
\caption{Imagen}

\end{figure}
\textit{Ep√≠grafe: Banco de trabajo durante las verificaciones del ZCD con osciloscopio.\}


\textbf{Figura 3.6 - Mediciones de pulsos ZCD (osciloscopio)\}
\begin{figure}[H]
\centering
\includegraphics[width=0.85\linewidth]{https://github.com/Embebidos-Fran-Marcos-Nacho/tdse-tf\_1-2/blob/663d795450e29c452e59a7ecae6f23108cb3e22d/Memoria\%20t\%C3\%A9cnica/cosas\%20e\%20imagenes\%20para\%20memoria\%20t\%C3\%A9cnica\%20-\%20hardware/ZCD/mediciones\%20pulsos.jpeg}
\caption{Imagen}

\end{figure}
\textit{Ep√≠grafe: Pulsos de salida del ZCD - cursor midiendo tiempo entre pulsos.\}

N√≥tese que el ZCD act√∫a en cada cruce por cero, generando una se√±al de 100 Hz.

\textbf{Figura 3.7 - Medici√≥n de ancho de pulso del ZCD\}
\begin{figure}[H]
\centering
\includegraphics[width=0.85\linewidth]{https://github.com/Embebidos-Fran-Marcos-Nacho/tdse-tf\_1-2/blob/663d795450e29c452e59a7ecae6f23108cb3e22d/Memoria\%20t\%C3\%A9cnica/cosas\%20e\%20imagenes\%20para\%20memoria\%20t\%C3\%A9cnica\%20-\%20hardware/ZCD/mediciones\%20pulsos\%201.jpeg}
\caption{Imagen}

\end{figure}
\textit{Ep√≠grafe: Salida del ZCD con la senoidal aplicada - cursor midiendo ancho de pulso.\}

\textbf{Figura 3.8 - Disparo previo al cruce real (senoidal negativa)\}
\begin{figure}[H]
\centering
\includegraphics[width=0.85\linewidth]{https://github.com/Embebidos-Fran-Marcos-Nacho/tdse-tf\_1-2/blob/663d795450e29c452e59a7ecae6f23108cb3e22d/Memoria\%20t\%C3\%A9cnica/cosas\%20e\%20imagenes\%20para\%20memoria\%20t\%C3\%A9cnica\%20-\%20hardware/ZCD/mediciones\%20pulsos\%202.jpeg}
\caption{Imagen}

\end{figure}
\textit{Ep√≠grafe: Salida del ZCD con la senoidal aplicada - cursor midiendo tiempo de disparo previo al cruce por cero real con senoidal negativa.\}

\textbf{Figura 3.9 - Disparo previo al cruce real (senoidal positiva)\}
\begin{figure}[H]
\centering
\includegraphics[width=0.85\linewidth]{https://github.com/Embebidos-Fran-Marcos-Nacho/tdse-tf\_1-2/blob/663d795450e29c452e59a7ecae6f23108cb3e22d/Memoria\%20t\%C3\%A9cnica/cosas\%20e\%20imagenes\%20para\%20memoria\%20t\%C3\%A9cnica\%20-\%20hardware/ZCD/mediciones\%20pulsos\%204.jpeg}
\caption{Imagen}

\end{figure}
\textit{Ep√≠grafe: Salida del ZCD con la senoidal aplicada - cursor midiendo tiempo de disparo previo al cruce por cero real con senoidal positiva.\}

El retardo fijo de disparo de los triacs se estim√≥ tomando de referencia los tiempos de disparo del ZCD respecto del cruce real mostrados en estas im√°genes.


\subsubsection{3.2.3 Etapa de potencia y protecciones}

Seg√∫n esquem√°tico principal (\texttt{Hardware/placa dimmer/dimmer.kicad\textbackslash{}\_sch\}), el canal de potencia integra:
\begin{itemize}
\item TRIAC de potencia (\texttt{BTA06-600C\}).
\item Optoacoplador de disparo (\texttt{MOC3023M\}).
\item Elementos de protecci√≥n (varistor, fusible, red RC/snubber opcional).
\end{itemize}

Notas de fabricaci√≥n y prueba:
\begin{itemize}
\item Primero se valid√≥ el correcto funcionamiento del ZCD, luego se integraron TRIACs.
\item Las primeras pruebas integradas se hicieron en 24 VAC. Esto conllev√≥ una ligera y reversible modificaci√≥n del circuito de ZCD.
\end{itemize}

\textbf{Figura 3.10 - Ensayo de salida de optoacoplador\}
\begin{figure}[H]
\centering
\includegraphics[width=0.85\linewidth]{https://github.com/Embebidos-Fran-Marcos-Nacho/tdse-tf\_1-2/blob/663d795450e29c452e59a7ecae6f23108cb3e22d/Memoria\%20t\%C3\%A9cnica/cosas\%20e\%20imagenes\%20para\%20memoria\%20t\%C3\%A9cnica\%20-\%20hardware/ZCD/salida\%20real\%20del\%20opto.jpeg}
\caption{Imagen}

\end{figure}
\textit{Ep√≠grafe: Se√±al a la salida del 4N25 en configuraci√≥n de emisor com√∫n/negador.\}

\textbf{Figura 3.11 - Simulaci√≥n de ZCD y salida de opto\}
\begin{figure}[H]
\centering
\includegraphics[width=0.85\linewidth]{https://github.com/Embebidos-Fran-Marcos-Nacho/tdse-tf\_1-2/blob/663d795450e29c452e59a7ecae6f23108cb3e22d/Memoria\%20t\%C3\%A9cnica/cosas\%20e\%20imagenes\%20para\%20memoria\%20t\%C3\%A9cnica\%20-\%20hardware/ZCD/simu\%20ZCD\%20proper.jpeg}
\caption{Imagen}

\end{figure}
\textit{Ep√≠grafe: Simulaci√≥n de la entrada y salida ideal del ZCD.\}

N√≥tese que es muy parecida a la medida.

\textbf{Figura 3.12 - Salida simulada del 4N25\}
\begin{figure}[H]
\centering
\includegraphics[width=0.85\linewidth]{https://github.com/Embebidos-Fran-Marcos-Nacho/tdse-tf\_1-2/blob/663d795450e29c452e59a7ecae6f23108cb3e22d/Memoria\%20t\%C3\%A9cnica/cosas\%20e\%20imagenes\%20para\%20memoria\%20t\%C3\%A9cnica\%20-\%20hardware/ZCD/simu\%20salida\%20del\%20optoacoplador.jpeg}
\caption{Imagen}

\end{figure}
\textit{Ep√≠grafe: Salida simulada del 4N25.\}

No se parece mucho a la real, pero funcion√≥ igual: la tensi√≥n alcanz√≥ el umbral para disparar los Schmitt triggers.


\subsubsection{3.2.4 Fabricaci√≥n de placas}

Se document√≥ el proceso de fabricaci√≥n con transferencia y ataque qu√≠mico:
\begin{itemize}
\item Primero se imprimi√≥ el dise√±o sobre un papel PnP Blue.
\item Luego se transfiri√≥ por medio de calor.
\item Se hicieron las correcciones manuales de transferencia.
\item Por √∫ltimo, se realiz√≥ un control de continuidad previo a energizar.
\end{itemize}

Lecciones aprendidas para pr√≥xima iteraci√≥n:
\begin{itemize}
\item Revisar di√°metros de agujeros para componentes de potencia (varistores y componentes grandes).
\item Simplificar topolog√≠a de ZCD.
\item Evaluar integraci√≥n de control de dimming en una etapa dedicada.
\end{itemize}

\textbf{Figura 3.13 - Papel de transferencia con dise√±o impreso\}
\begin{figure}[H]
\centering
\includegraphics[width=0.85\linewidth]{https://github.com/Embebidos-Fran-Marcos-Nacho/tdse-tf\_1-2/blob/1030475e09d21a3204b19eb7996e9f11bb688033/Memoria\%20t\%C3\%A9cnica/cosas\%20e\%20imagenes\%20para\%20memoria\%20t\%C3\%A9cnica\%20-\%20hardware/fab\%20placa/p\%20n\%20p\%20blue.jpeg}
\caption{Imagen}

\end{figure}
\textit{Ep√≠grafe: Papel de transferencia con el dise√±o impreso.\}

\textbf{Figura 3.14 - Transferencia previa a correcciones\}
\begin{figure}[H]
\centering
\includegraphics[width=0.85\linewidth]{https://github.com/Embebidos-Fran-Marcos-Nacho/tdse-tf\_1-2/blob/1030475e09d21a3204b19eb7996e9f11bb688033/Memoria\%20t\%C3\%A9cnica/cosas\%20e\%20imagenes\%20para\%20memoria\%20t\%C3\%A9cnica\%20-\%20hardware/fab\%20placa/trasferencia\%20a\%20cobre.jpeg}
\caption{Imagen}

\end{figure}
\textit{Ep√≠grafe: Transferencia previa a correcciones.\}

\textbf{Figura 3.15 - Transferencia corregida\}
\begin{figure}[H]
\centering
\includegraphics[width=0.85\linewidth]{https://github.com/Embebidos-Fran-Marcos-Nacho/tdse-tf\_1-2/blob/1030475e09d21a3204b19eb7996e9f11bb688033/Memoria\%20t\%C3\%A9cnica/cosas\%20e\%20imagenes\%20para\%20memoria\%20t\%C3\%A9cnica\%20-\%20hardware/fab\%20placa/correci\%C3\%B3n\%20de\%20desperfectos\%20de\%20trasnferencia.jpeg}
\caption{Imagen}

\end{figure}
\textit{Ep√≠grafe: Transferencia corregida.\}

\textbf{Figura 3.16 - Placa fabricada\}
\begin{figure}[H]
\centering
\includegraphics[width=0.85\linewidth]{https://github.com/Embebidos-Fran-Marcos-Nacho/tdse-tf\_1-2/blob/663d795450e29c452e59a7ecae6f23108cb3e22d/Memoria\%20t\%C3\%A9cnica/cosas\%20e\%20imagenes\%20para\%20memoria\%20t\%C3\%A9cnica\%20-\%20hardware/fab\%20placa/cobre\%20etched.jpeg}
\caption{Imagen}

\end{figure}
\textit{Ep√≠grafe: Placa fabricada.\}


\subsubsection{3.2.5 Pinout del sistema (STM32F103RB)}

\begin{table}[h]
\centering
\begin{tabular}{ll}
\toprule
Pin & Funci√≥n \\
\midrule
\texttt{PA0\} & Potenci√≥metro (ADC) \\
\texttt{PC0\} & DIP1: habilitaci√≥n Bluetooth \\
\texttt{PC1\} & DIP2: habilitaci√≥n buzzer \\
\texttt{PB0\} & DIP3: habilitaci√≥n LED \\
\texttt{PA4\} & DIP4: forzado de estado \texttt{FAULT\} \\
\texttt{PC12\} & Bot√≥n ON de luz \\
\texttt{PC9\} & Bot√≥n OFF de luz \\
\texttt{PC2\} & ZCD (EXTI) \\
\texttt{PB3\} & TRIAC canal ventilador \\
\texttt{PB4\} & TRIAC canal luz \\
\texttt{PB13\} & LED \\
\texttt{PA8\} & Buzzer (\texttt{TIM1\textbackslash{}\_CH1\}) \\
\texttt{PA9/PA10\} & USART1 (HC-06) \\
\texttt{PA2/PA3\} & USART2 (consola ST-Link VCP) \\
\texttt{PC8\} & Onda de prueba 100 Hz (modo test) \\
\bottomrule
\end{tabular}
\end{table}

\subsubsection{3.2.6 Cableado e im√°genes del montaje}

\textbf{Figura 3.17 - Cableado final del prototipo\}

\begin{figure}[H]
\centering
\includegraphics[width=0.85\linewidth]{https://github.com/Embebidos-Fran-Marcos-Nacho/tdse-tf\_1-2/blob/3cb04d32ab982e06ec97e47ec6184a648ebf46cf/Memoria\%20t\%C3\%A9cnica/cosas\%20e\%20imagenes\%20para\%20memoria\%20t\%C3\%A9cnica\%20-\%20hardware/banco\%20de\%20trabajo\%20desprolijo/banco\%20final.jpeg}
\caption{Imagen}

\end{figure}

\textit{Ep√≠grafe: Montaje final del prototipo durante ensayo integrado.\}


\textbf{Figura 3.18 - Diagrama de conexi√≥n entre placas simplificado\}

\begin{figure}[H]
\centering
\includegraphics[width=0.85\linewidth]{https://github.com/Embebidos-Fran-Marcos-Nacho/tdse-tf\_1-2/blob/00693ac864a65b0389699a47c52606a88d0adbb9/Diagrama\%20de\%20conexi\%C3\%B3n\%20simplificado/conexionado.png}
\caption{Imagen}

\end{figure}

\textit{Ep√≠grafe: Diagrama simplificado de conexi√≥n entre placas.\}

\textbf{Figura 3.19 - Overview de placa shield y conexionado\}

\begin{figure}[H]
\centering
\includegraphics[width=0.85\linewidth]{https://github.com/Embebidos-Fran-Marcos-Nacho/tdse-tf\_1-2/blob/c2fc7354b11ef4655cebe90b4b788acc5695045a/Diagrama\%20de\%20conexi\%C3\%B3n\%20simplificado/f103rb.jpg}
\caption{Imagen}

\end{figure}

\textit{Ep√≠grafe: Vista general y conexionado de la shield para F103RB.\}

\textbf{Figura 3.20 - Conexionado de placa de TRIACs\}

\begin{figure}[H]
\centering
\includegraphics[width=0.85\linewidth]{https://github.com/Embebidos-Fran-Marcos-Nacho/tdse-tf\_1-2/blob/c2fc7354b11ef4655cebe90b4b788acc5695045a/Diagrama\%20de\%20conexi\%C3\%B3n\%20simplificado/triacs.jpg}
\caption{Imagen}

\end{figure}

\textit{Ep√≠grafe: Conexionado de la placa de TRIACs y cargas.\}


\subsection{Dise√±o de firmware}

\subsubsection{3.3.1 Arquitectura de ejecuci√≥n}

El firmware implementa un esquema \textit{bare-metal\} con super-loop y tick de 1 ms (\texttt{HAL\textbackslash{}\_SYSTICK\textbackslash{}\_Callback\}), recorriendo en orden fijo:
\begin{enumerate}
\item \texttt{task\textbackslash{}\_adc\textbackslash{}\_update\}
\item \texttt{task\textbackslash{}\_system\textbackslash{}\_update\}
\item \texttt{task\textbackslash{}\_pwm\textbackslash{}\_update\}
\end{enumerate}

Cada tarea se ejecuta en cada tick y su tiempo se mide con contador de ciclos (\texttt{DWT->CYCCNT\}) para c√°lculo de WCET.

\subsubsection{3.3.2 M√°quina de estados del sistema}

\texttt{task\textbackslash{}\_system.c\} implementa la m√°quina de estado global:
\begin{itemize}
\item \texttt{ST\textbackslash{}\_INIT\textbackslash{}\_READ\textbackslash{}\_FLASH\}
\item \texttt{ST\textbackslash{}\_INIT\textbackslash{}\_READ\textbackslash{}\_DIP\}
\item \texttt{ST\textbackslash{}\_INIT\textbackslash{}\_CHECK\textbackslash{}\_SENSORS\}
\item \texttt{ST\textbackslash{}\_INIT\textbackslash{}\_RESTORE\textbackslash{}\_PWM\}
\item \texttt{ST\textbackslash{}\_INIT\textbackslash{}\_CONFIG\textbackslash{}\_BT\}
\item \texttt{ST\textbackslash{}\_NORMAL\}
\item \texttt{ST\textbackslash{}\_FAULT\}
\end{itemize}

En \texttt{FAULT\}:
\begin{itemize}
\item se corta potencia (\texttt{cut\textbackslash{}\_off\textbackslash{}\_voltage=true\}).
\item se activa patr√≥n de alarma.
\item se reintenta inicializaci√≥n por timeout.
\end{itemize}

\textbf{Figura 3.21 - Statechart general (Harel/Itemis)\}
\begin{figure}[H]
\centering
\includegraphics[width=0.85\linewidth]{https://github.com/Embebidos-Fran-Marcos-Nacho/tdse-tf\_1-2/blob/3cb04d32ab982e06ec97e47ec6184a648ebf46cf/Memoria\%20t\%C3\%A9cnica/imgs/Statechart.png}
\caption{Imagen}

\end{figure}

\textbf{Figura 3.22 - Subestados de inicializaci√≥n\}
\begin{figure}[H]
\centering
\includegraphics[width=0.85\linewidth]{https://github.com/Embebidos-Fran-Marcos-Nacho/tdse-tf\_1-2/blob/169b5aabae5e8c5a7af391914271a01397db4f61/Memoria\%20t\%C3\%A9cnica/imgs/State\%20Init.png}
\caption{Imagen}

\end{figure}

\textbf{Figura 3.23 - Estado normal\}
\begin{figure}[H]
\centering
\includegraphics[width=0.85\linewidth]{https://github.com/Embebidos-Fran-Marcos-Nacho/tdse-tf\_1-2/blob/3cb04d32ab982e06ec97e47ec6184a648ebf46cf/Memoria\%20t\%C3\%A9cnica/imgs/State\%20Normal.png}
\caption{Imagen}

\end{figure}

\textbf{Figura 3.24 - Estado de falla\}
\begin{figure}[H]
\centering
\includegraphics[width=0.85\linewidth]{https://github.com/Embebidos-Fran-Marcos-Nacho/tdse-tf\_1-2/blob/3cb04d32ab982e06ec97e47ec6184a648ebf46cf/Memoria\%20t\%C3\%A9cnica/imgs/State\%20Fault\_ST.png}
\caption{Imagen}

\end{figure}

\textbf{Figura 3.25 - FSM de debounce de bot√≥n\}
\begin{figure}[H]
\centering
\includegraphics[width=0.85\linewidth]{https://github.com/Embebidos-Fran-Marcos-Nacho/tdse-tf\_1-2/blob/3cb04d32ab982e06ec97e47ec6184a648ebf46cf/Memoria\%20t\%C3\%A9cnica/imgs/ST\_BTN.png}
\caption{Imagen}

\end{figure}

\subsubsection{3.3.3 Entradas y acondicionamiento l√≥gico}

\begin{itemize}
\item Debounce por m√°quina de estados para botones ON/OFF.
\item Muestreo ADC peri√≥dico (\texttt{ADC\textbackslash{}\_PERIOD\textbackslash{}\_MS = 50 ms\}).
\item Escalado del potenci√≥metro usando l√≠mites de calibraci√≥n manual:
\item m√≠nimo: 696 cuentas.
\item m√°ximo: 3194 cuentas.
\item Filtro por deadband para evento de potenci√≥metro (\texttt{APP\textbackslash{}\_ADC\textbackslash{}\_PERCENT\textbackslash{}\_EVENT\textbackslash{}\_DEADBAND = 2\textbackslash{}\%\}) para evitar oscilaciones por ruido (ej. 99\% <-> 100\%).
Esto √∫ltimo asegura una excursi√≥n correcta que considera las caidas de tensi√≥n en la placa de control.
\end{itemize}

\subsubsection{3.3.4 Control de TRIAC y sincronizaci√≥n AC}

\texttt{task\textbackslash{}\_pwm.c\} usa \texttt{TIM2\} para programar ventanas ON/OFF por semiciclo:
\begin{itemize}
\item retardo fijo de referencia: \texttt{APP\textbackslash{}\_TRIAC\textbackslash{}\_FIXED\textbackslash{}\_WAIT\textbackslash{}\_US = 700 us\}.
\item ancho de pulso de gate: \texttt{APP\textbackslash{}\_TRIAC\textbackslash{}\_PULSE\textbackslash{}\_US = 1000 us\}.
\item retardo variable del ventilador por porcentaje (\texttt{fan\textbackslash{}\_delay\textbackslash{}\_us\}).
\end{itemize}

El evento de cruce por cero llega por EXTI en \texttt{PC2\}.

\subsubsection{3.3.5 Persistencia en flash}

Se utiliza una p√°gina dedicada de flash interna (\texttt{0x0801FC00\}) para:
\begin{itemize}
\item palabra m√°gica.
\item versi√≥n de layout.
\item estado de luz.
\item calibraci√≥n ADC min/max.
\end{itemize}

Si el guardado cr√≠tico falla (seg√∫n configuraci√≥n estricta), la FSM puede entrar en \texttt{FAULT\}.

\subsubsection{3.3.6 Bluetooth HC-06}

Configuraci√≥n:
\begin{itemize}
\item nombre: \texttt{Dimmer\textbackslash{}\_BL\}.
\item PIN: \texttt{1111\}.
\item comandos AT enviados sin CR/LF y con retardos adecuados.
\end{itemize}

Funcionamiento en firmware:
\begin{itemize}
\item UART por \texttt{USART1\}.
\item telemetr√≠a binaria (sin JSON).
\item 2 bytes por frame:
\item byte 0: \texttt{adc\textbackslash{}\_percent\} (0..100).
\item byte 1: \texttt{light\textbackslash{}\_enabled\} (0/1).
\item Env√≠o peri√≥dico por tiempo (no por cambio), configurable con \texttt{APP\textbackslash{}\_BT\textbackslash{}\_TELEMETRY\textbackslash{}\_PERIOD\textbackslash{}\_MS\} (actualmente \texttt{50 ms\}). Esto ayud√≥ mucho a mejorar los WCET debido a que el uso de la consola parece tomar mucho tiempo.
\end{itemize}

Nota: actualmente la app se usa como receptor de estado, no como control remoto completo de actuadores.

\subsubsection{3.3.7 Aplicaci√≥n m√≥vil}

La app fue desarrollada en MIT App Inventor. Se documentan interfaz y bloques de procesamiento de bytes.

\textbf{Figura 3.26 - Pantalla principal app\}

\begin{figure}[H]
\centering
\includegraphics[width=0.85\linewidth]{https://github.com/Embebidos-Fran-Marcos-Nacho/tdse-tf\_1-2/blob/566a7314061481abbec17f240388ee198cea82ee/Memoria\%20t\%C3\%A9cnica/cosas\%20e\%20imagenes\%20para\%20memoria\%20t\%C3\%A9cnica\%20-\%20hardware/captura\%20app.jpeg}
\caption{Imagen}

\end{figure}

\textit{Ep√≠grafe: Pantalla principal de la App.\}


\textbf{Figura 3.27 - Bloques MIT App Inventor (parte 1)\}

\begin{figure}[H]
\centering
\includegraphics[width=0.85\linewidth]{https://github.com/Embebidos-Fran-Marcos-Nacho/tdse-tf\_1-2/blob/65b6a1be5b7a1b68e959d041707e17e00ebe5659/Memoria\%20t\%C3\%A9cnica/imgs/mit\%20app\%20bloque\%201.png}
\caption{Imagen}

\end{figure}

\textit{Ep√≠grafe: Bloques de inicializaci√≥n de la pantalla principal.\}

\textbf{Figura 3.28 - Bloques MIT App Inventor (parte 2)\}

\begin{figure}[H]
\centering
\includegraphics[width=0.85\linewidth]{https://github.com/Embebidos-Fran-Marcos-Nacho/tdse-tf\_1-2/blob/65b6a1be5b7a1b68e959d041707e17e00ebe5659/Memoria\%20t\%C3\%A9cnica/imgs/mit\%20app\%20bloque\%202.png}
\caption{Imagen}

\end{figure}

\textit{Ep√≠grafe: L√≥gica de actualizaci√≥n de datos y pantalla.\}

\textbf{Figura 3.29 - Bloques MIT App Inventor (parte 3)\}

\begin{figure}[H]
\centering
\includegraphics[width=0.85\linewidth]{https://github.com/Embebidos-Fran-Marcos-Nacho/tdse-tf\_1-2/blob/65b6a1be5b7a1b68e959d041707e17e00ebe5659/Memoria\%20t\%C3\%A9cnica/imgs/mit\%20app\%20bloque\%203.png}
\caption{Imagen}

\end{figure}

\textit{Ep√≠grafe: L√≥gica de selecci√≥n de dispositivo bluetooth.\}

\hrulefill

\section{Ensayos y resultados}

\subsection{Pruebas funcionales de hardware}

\begin{table}[h]
\centering
\begin{tabularx}{\linewidth}{llX}
\toprule
Ensayo & Resultado & Estado \\
\midrule
Integridad de placas (continuidad) & Validaci√≥n previa a energizaci√≥n & ‚úÖ \\
ZCD en banco & Detecci√≥n de eventos y correlaci√≥n con simulaci√≥n & ‚úÖ \\
Integraci√≥n con 24 VAC & Prueba inicial de etapa integrada & ‚úÖ \\
Observar integridad de dimming en 24 VAC (osciloscopio) & Se verific√≥ por medio de osciloscopio & ‚úÖ \\
\bottomrule
\end{tabularx}
\end{table}

\subsection{Pruebas funcionales de firmware}

\begin{table}[h]
\centering
\begin{tabularx}{\linewidth}{llX}
\toprule
Ensayo & Resultado & Estado \\
\midrule
Debounce botones ON/OFF & Eventos limpios sobre FSM & ‚úÖ \\
Muestreo ADC + mapeo & Escalado operativo 0..100\% & ‚úÖ \\
FSM de sistema (\texttt{INIT/NORMAL/FAULT\}) & Transiciones v√°lidas en logs & ‚úÖ \\
Persistencia flash & Lectura/escritura de estado y calibraci√≥n & ‚úÖ \\
Telemetr√≠a BT (2 bytes) & Trama enviada en forma peri√≥dica (\texttt{APP\textbackslash{}\_BT\textbackslash{}\_TELEMETRY\textbackslash{}\_PERIOD\textbackslash{}\_MS\}) & ‚úÖ \\
\bottomrule
\end{tabularx}
\end{table}

\subsection{Pruebas de integraci√≥n}

Se valid√≥ la interacci√≥n completa:
\begin{itemize}
\item entradas f√≠sicas.
\item control de potencia.
\item telemetr√≠a hacia app.
\end{itemize}

\textbf{Video de integraci√≥n en funcionamiento\}

\url{https://youtu.be/iv2bGrqrMtU}



\subsection{Medici√≥n y an√°lisis de consumo}

Metodolog√≠a aplicada:
\begin{itemize}
\item medici√≥n de consumo total en la entrada de \texttt{5V\} del sistema (NUCLEO + shield).
\item alimentaci√≥n desde fuente externa conectada a pines \texttt{5V\} y \texttt{GND\}.
\item medici√≥n de corriente con mult√≠metro en serie sobre la l√≠nea de \texttt{5V\}.
\item medici√≥n de tensi√≥n en bornes de entrada para estimar potencia (\texttt{P = V * I\}).
\end{itemize}

Procedimiento realizado:
\begin{enumerate}
\item Desconectar USB/ST-Link para evitar doble alimentaci√≥n.
\item Conectar fuente externa a \texttt{5V\} y \texttt{GND\}.
\item Ajustar la fuente para garantizar \texttt{5V\} en el pin \texttt{5V\} de la placa (compensando ca√≠das en cables).
\item Intercalar amper√≠metro en serie en la l√≠nea de \texttt{5V\}.
\item Medir tensi√≥n de entrada en paralelo sobre \texttt{5V-GND\}.
\item Registrar datos en los modos:
\end{enumerate}
\begin{itemize}
\item normal sin m√≥dulo Bluetooth conectado.
\item normal con m√≥dulo Bluetooth conectado pero desactivado.
\item normal con Bluetooth activo enviando datos.
\item fault con alarma activa (buzzer + LED).
\end{itemize}
\begin{enumerate}
\item Debido a que el consumo oscila r√°pidamente en el tiempo, se tom√≥ como referencia el valor pico observado en cada modo.
\end{enumerate}

Alcance de la medici√≥n:
\begin{itemize}
\item Esta medici√≥n representa el consumo total a \texttt{5V\} del conjunto montado.
\item El riel de \texttt{3.3V\} queda incluido indirectamente, ya que se genera desde \texttt{5V\} mediante el regulador de la placa. Adem√°s, registrar el consumo de 3.3V solo no tiene sentido para un sistema que se alimenta com 5V.
\end{itemize}

\begin{table}[h]
\centering
\begin{tabularx}{\linewidth}{lrrX}
\toprule
Modo & I pico @5V [mA] & P pico @5V [W] & Observaciones \\
\midrule
Normal sin m√≥dulo BT (desconectado) & 64 & 0.320 & Escenario de menor consumo; representa una forma v√°lida de uso sin telemetr√≠a Bluetooth. \\
Normal con m√≥dulo BT conectado y desactivado & 104 & 0.520 & Aumento de consumo por presencia/alimentaci√≥n del m√≥dulo Bluetooth. \\
Normal con BT activo enviando datos & 107 & 0.535 & Incremento leve respecto al modo BT desactivado. \\
Fault (buzzer + LED activos) & 145 & 0.725 & Peor caso medido en operaci√≥n. \\
\bottomrule
\end{tabularx}
\end{table}

An√°lisis:
\begin{itemize}
\item Potencia calculada como \texttt{P = V * I\}, usando \texttt{V = 5V\} y corriente pico medida en cada modo.
\item El peor caso medido fue \texttt{145 mA\} a \texttt{5V\}, equivalente a \texttt{0.725 W\}.
\item El sistema se mantiene por debajo de \texttt{1 W\}, por lo que puede alimentarse sin inconvenientes con fuentes comerciales 220VAC->5V de baja potencia.
\item La diferencia entre BT desactivado y BT transmitiendo (\texttt{104 mA\} -> \texttt{107 mA\}) es baja, consistente con carga adicional moderada por comunicaci√≥n.
\end{itemize}

\subsection{Console and Build Analyzer}

Resultado consolidado de herramientas de an√°lisis de consola y build.

\textbf{Figura 4.1 - Console and Build Analyzer\}

\begin{figure}[H]
\centering
\includegraphics[width=0.85\linewidth]{https://github.com/Embebidos-Fran-Marcos-Nacho/tdse-tf\_1-2/blob/c2fc7354b11ef4655cebe90b4b788acc5695045a/Memoria\%20t\%C3\%A9cnica/imgs/build\%20console\%20y\%20analyzer.png}
\caption{Imagen}

\end{figure}

\textit{Ep√≠grafe: Build console y build analyzer. Dice RAM: 10.31\textbackslash{}\% y FLASH: 16.11\textbackslash{}\% \}



\subsection{Medici√≥n y an√°lisis de WCET por tarea}

El firmware instrumenta WCET por tarea en \texttt{app.c\} usando \texttt{DWT->CYCCNT\} y un modo de perfilado limpio (\texttt{[PROF]\}) activado temporalmente durante ensayo:
\begin{itemize}
\item \texttt{WCETw\} = WCET en ventana (steady-state, √∫ltimos 1000 ciclos)
\item \texttt{WCETb\} = WCET acumulado desde boot
\item \texttt{Cavg\} = tiempo promedio de ejecuci√≥n
\end{itemize}

Metodolog√≠a realizada:
\begin{enumerate}
\item Flashear build \texttt{Software STM32/main\} en NUCLEO-F103RB.
\item Abrir consola serial (USART2, 115200 baud).
\item Ejecutar con trazas de test desactivadas (\texttt{APP\textbackslash{}\_TEST\textbackslash{}\_MODE = 0\}) y perfil limpio activo durante la medici√≥n.
\item Dejar correr el sistema en estado idle (sin pulsaciones ni cambios ADC).
\item Registrar m√∫ltiples ventanas \texttt{[PROF]\} (n\textasciitilde{}1010 por ventana).
\end{enumerate}

Es decir, se us√≥ el mismo programa pero con un modo de estimaci√≥n del WCET.

Formato de log utilizado y significado de par√°metros:
\begin{itemize}
\item \texttt{n\}: cantidad de ciclos de scheduler medidos en la ventana.
\item \texttt{ov\}: cantidad de overruns (ciclos cuyo runtime total supera 1 ms).
\item \texttt{qmax\}: m√°ximo backlog observado en la cola de ticks (\texttt{g\textbackslash{}\_app\textbackslash{}\_tick\textbackslash{}\_cnt\}) durante la ventana.
\item \texttt{Cavg=\textbackslash{}\{adc,sys,pwm\textbackslash{}\}\}: tiempo promedio por tarea en la ventana (us).
\item \texttt{WCETw=\textbackslash{}\{adc,sys,pwm\textbackslash{}\}\}: peor tiempo por tarea dentro de la ventana (us).
\item \texttt{CPU=\textbackslash{}\{avg,peak\textbackslash{}\}\}: utilizaci√≥n total promedio y pico del scheduler en la ventana (\%).
\item \texttt{U=\textbackslash{}\{avg,wcet\textbackslash{}\}\}: factor de uso promedio y por peor caso reportado para la ventana.
\end{itemize}

Criterio de consolidaci√≥n de resultados:
\begin{itemize}
\item Se tomaron 15 l√≠neas consecutivas \texttt{[PROF]\}.
\item Para \texttt{Cavg t√≠pico\} se report√≥ el rango estable observado.
\item Para \texttt{WCETw m√°x observado\} se tom√≥ el m√°ximo absoluto entre las 15 ventanas.
\item Para \texttt{U\} se report√≥ rango observado por ventana y cota conservadora adicional.
\end{itemize}

Es muy importante destacar que el uso de la consola eleva masivamente los WCET, por lo que se minimiz√≥ en las evaluaciones.

\textbf{Resultados medidos (estado idle/estable, 15 ventanas):\}

\begin{table}[h]
\centering
\begin{tabularx}{\linewidth}{lrrX}
\toprule
Tarea & Per√≠odo asumido [us] & Cavg t√≠pico [us] & WCETw m√°x observado [us] \\
\midrule
\texttt{task\textbackslash{}\_adc\textbackslash{}\_update\} & 1000 & 64..66 & 268 \\
\texttt{task\textbackslash{}\_system\textbackslash{}\_update\} & 1000 & 26 & 125 \\
\texttt{task\textbackslash{}\_pwm\textbackslash{}\_update\} & 1000 & 46..48 & 292 \\
\bottomrule
\end{tabularx}
\end{table}

\textbf{Observaciones:\}
\begin{itemize}
\item No se observaron overruns (\texttt{ov=0\}) en ninguna ventana.
\item \texttt{qmax=10\} se mantuvo estable en todas las ventanas registradas.
\item Uso de CPU: \texttt{CPU avg\} entre \texttt{13.6\textbackslash{}\%\} y \texttt{14.0\textbackslash{}\%\}; \texttt{CPU peak\} entre \texttt{35.6\textbackslash{}\%\} y \texttt{38.0\textbackslash{}\%\}.
\end{itemize}


\subsection{C√°lculo del factor de uso de CPU (U)}

Para evaluar la carga temporal del sistema se calcul√≥ el factor de utilizaci√≥n de CPU utilizando la expresi√≥n cl√°sica de sistemas en tiempo real:

\textbackslash{}\textbackslash{}[U = \textbackslash{}sum\_\{i=1\}\textasciicircum{}\{n\} \textbackslash{}frac\{C\_i\}\{T\_i\}\textbackslash{}\textbackslash{}]

donde (C\_i) representa el WCET de la tarea (i), medido a partir de ventanas de ejecuci√≥n en r√©gimen estacionario, y (T\_i) su per√≠odo de activaci√≥n.

La Tabla siguiente resume los valores utilizados para el c√°lculo:

\begin{table}[h]
\centering
\begin{tabularx}{\linewidth}{lrrX}
\toprule
Tarea & (C\_i) (WCET) [¬µs] & (T\_i) [¬µs] & (C\_i/T\_i) \\
\midrule
\texttt{task\textbackslash{}\_adc\textbackslash{}\_update\} & 268 & 1000 & 0.268 \\
\texttt{task\textbackslash{}\_system\textbackslash{}\_update\} & 125 & 1000 & 0.125 \\
\texttt{task\textbackslash{}\_pwm\textbackslash{}\_update\} & 292 & 1000 & 0.292 \\
\textbf{Total (U) (WCET-based, conservador)\} & ‚Äì & ‚Äì & \textbf{0.685\} \\
\bottomrule
\end{tabularx}
\end{table}

El valor total obtenido, (\$U = 0.685\$), corresponde a una cota conservadora, ya que se construy√≥ combinando los m√°ximos tiempos de ejecuci√≥n observados para cada tarea en ventanas temporales distintas y no a partir de una ocurrencia simult√°nea real de dichos m√°ximos.

En contraste, las mediciones experimentales mostraron valores de utilizaci√≥n sensiblemente menores: la utilizaci√≥n basada en ventanas ((\$U\_\{wcet\}\$)) se mantuvo entre \$46,5\$ \% y \$66,1\$ \%, mientras que la utilizaci√≥n promedio ((\$U\_\{avg\}\$)) se ubic√≥ en torno al 14 \% en r√©gimen permanente. En el caso particular del STM32F103RB, estos resultados indican un comportamiento temporal estable, con un margen de CPU suficiente para absorber variaciones transitorias de ejecuci√≥n sin comprometer el cumplimiento de los per√≠odos de las tareas, validando as√≠ la factibilidad temporal del dise√±o.


\subsection{Gesti√≥n de bajo consumo y justificaci√≥n}

En esta iteraci√≥n del TP no se implement√≥ una estrategia dedicada de bajo consumo a nivel firmware (por ejemplo, entrada expl√≠cita a modos \texttt{Sleep/Stop\} ni escalado din√°mico de frecuencia), ya que el objetivo principal fue priorizar robustez funcional, seguridad el√©ctrica y cierre de integraci√≥n.

No obstante, se evalu√≥ el impacto energ√©tico real del sistema y los resultados muestran que el consumo del conjunto est√° dominado principalmente por el hardware perif√©rico y la plataforma de prototipado:
\begin{itemize}
\item El salto de consumo al conectar el m√≥dulo Bluetooth es significativo (\texttt{64 mA\} -> \texttt{104 mA\}), aun sin transmitir.
\item La diferencia entre Bluetooth desactivado y transmitiendo es menor (\texttt{104 mA\} -> \texttt{107 mA\}).
\item En falla, el mayor consumo se explica por actuadores/indicadores (\texttt{buzzer + LED\}), no por carga computacional del CPU.
\end{itemize}

Esto es consistente con el factor de uso medido (\texttt{Uavg\} alrededor de \texttt{14\textbackslash{}\%\} y cota conservadora \texttt{Uwcet = 0.685\}): la carga temporal del microcontrolador no aparece como cuello de botella energ√©tico principal en el prototipo actual.

En una versi√≥n orientada a producto (placa dedicada, sin sobrecarga de NUCLEO y perif√©ricos de laboratorio), s√≠ corresponde aplicar optimizaci√≥n sistem√°tica de consumo:

\begin{itemize}
\item Reducir frecuencia de reloj del MCU al m√≠nimo compatible con temporizaci√≥n y control de TRIAC.
\item Incorporar pol√≠tica de idle de bajo consumo (entrada a \texttt{Sleep\} entre eventos peri√≥dicos/interrupts).
\item Migrar de HC-06 (Bluetooth cl√°sico) a BLE para telemetr√≠a de bajo consumo.
\item Revisar arquitectura de hardware auxiliar (drivers, conversores, etapas de acondicionamiento y protecciones) para eliminar consumo no esencial.
\end{itemize}

Conclusi√≥n: para el alcance acad√©mico de esta entrega, el consumo observado est√° mayormente determinado por decisiones de hardware e instrumentaci√≥n de prototipo. La optimizaci√≥n fina de bajo consumo queda planificada como mejora de pr√≥xima revisi√≥n de dise√±o.

\subsection{Cumplimiento de requisitos}

\begin{table}[h]
\centering
\begin{tabularx}{\linewidth}{llccX}
\toprule
ID & Requisito (versi√≥n final) & Hardware & Software & Estado final \\
\midrule
1.1 & El sistema permitir√° encender y apagar las luces mediante un bot√≥n f√≠sico. & üü¢ & üü¢ & ‚úÖ \\
1.2 & El sistema permitir√° ajustar la velocidad del ventilador mediante un potenci√≥metro. & üü¢ & üü¢ & ‚úÖ \\
1.3 & El sistema permitir√° ver el estado del ventilador y las luces v√≠a Bluetooth. & üü¢ & üü¢ & ‚úÖ \\
2.1 & El sistema contar√° con un DIP switch para habilitar o deshabilitar el Bluetooth. & üü¢ & üü¢ & ‚úÖ \\
2.2 & El DIP switch permitir√° seleccionar configuraciones o canales del m√≥dulo Bluetooth. & üü¢ & üî¥ & üî¥ \\
3.1 & El sistema contar√° con LEDs que indiquen el estado del Bluetooth. & üü¢ & üü¢ & ‚úÖ \\
3.2 & El sistema contar√° con un buzzer para se√±alizar eventos del sistema. & üü¢ & üü¢ & ‚úÖ \\
4.1 & El sistema deber√° guardar en memoria flash el √∫ltimo valor de PWM utilizado. & üü¢ & üü¢ & ‚úÖ \\
4.2 & El sistema deber√° restaurar autom√°ticamente el √∫ltimo valor guardado al encender. & üü¢ & üü¢ & ‚úÖ \\
5.1 & El sistema deber√° operar de forma segura sobre cargas de 220 VAC. & üü° & N/A & üü° \\
6.1 & La aplicaci√≥n dar√° informaci√≥n sobre los estados disponibles, que incluyen la velocidad del ventilador y el estado de luces. & N/A & üü¢ & ‚úÖ \\
6.2 & El sistema deber√° evitar conflictos entre el control f√≠sico y la comunicaci√≥n Bluetooth, incluyendo conflictos de timings. & N/A & üü¢ & ‚úÖ \\
\bottomrule
\end{tabularx}
\end{table}

Leyenda:
\begin{itemize}
\item üü¢ implementado
\item üü° parcialmente cumplido / con alcance acotado en prototipo
\item üî¥ no implementado / descartado
\item ‚úÖ cumplido
\end{itemize}

Observaci√≥n sobre el requisito 5.1 (220 VAC):
\begin{itemize}
\item La validaci√≥n final sobre red de 220 VAC queda planificada para la etapa posterior a la aprobaci√≥n acad√©mica del trabajo.
\item Esta decisi√≥n se toma para reducir el riesgo de da√±o de la placa durante la instancia de entrega y evaluaci√≥n.
\end{itemize}

Observaci√≥n sobre el requisito 2.2 (canales/configuraci√≥n Bluetooth):
\begin{itemize}
\item En la implementaci√≥n final no se desarroll√≥ la selecci√≥n de canales/configuraciones por DIP para Bluetooth.
\item Se descart√≥ por no ser necesario para el funcionamiento objetivo del sistema (telemetr√≠a de estado).
\end{itemize}

\subsection{Comparaci√≥n con sistemas similares}

\begin{table}[h]
\centering
\begin{tabularx}{\linewidth}{lccX}
\toprule
Caracter√≠stica & Control IR/RF b√°sico & Soluci√≥n Wi-Fi comercial & Este proyecto \\
\midrule
Interfaz local de pared & No & Generalmente no & S√≠ \\
App m√≥vil & No & S√≠ & S√≠ (telemetr√≠a) \\
Personalizaci√≥n firmware & No & No & S√≠ \\
Persistencia local & Variable & S√≠ & S√≠ \\
Costo de prototipo acad√©mico & N/A & Alto & Medio \\
\bottomrule
\end{tabularx}
\end{table}

\subsection{Documentaci√≥n del desarrollo realizado}

Material t√©cnico disponible en repositorio:
\begin{itemize}
\item C√≥digo fuente STM32 (\texttt{Software STM32/main\}).
\item Esquem√°ticos y PCB (\texttt{Hardware/placa dimmer\}, \texttt{Hardware/placa shield\}).
\item Diagramas de estado (\texttt{Diagrama de Harel\}).
\item App m√≥vil (\texttt{app celular\}).
\item Memoria t√©cnica y contenido gr√°fico (\texttt{Memoria t√©cnica\}).
\end{itemize}

\hrulefill

\section{Conclusiones}

\subsection{Resultados obtenidos}

Se obtuvo un prototipo funcional que integra:
\begin{itemize}
\item Control local de luz y ventilador.
\item Sincronizaci√≥n con cruce por cero para disparo de TRIAC.
\item Telemetr√≠a por Bluetooth HC-06.
\item Persistencia en flash y manejo de falla segura.
\end{itemize}

Tambi√©n se estableci√≥ una base s√≥lida de documentaci√≥n t√©cnica para cierre de entrega final.

El proyecto permiti√≥ conocer los Triacs como componentes de control de potencia, adem√°s de permitir ahondar en lo que es el desarrollo de sistemas embebidos a peque√±a escala.

\subsection{Lecciones aprendidas}

\begin{itemize}
\item El circuito de ZCD actual funciona, pero resulta m√°s complejo de lo necesario para una pr√≥xima iteraci√≥n.
\item La compensaci√≥n temporal del cruce por cero (aprox. 500 us) es cr√≠tica para estabilidad del dimming.
\item La fabricaci√≥n de PCB artesanal aceler√≥ iteraciones, pero exige mayor cuidado mec√°nico en footprints de componentes de potencia.
\item La telemetr√≠a binaria de 2 bytes simplific√≥ integraci√≥n y depuraci√≥n con app m√≥vil.
\end{itemize}

\subsection{Pr√≥ximos pasos}

\begin{itemize}
\item Evaluar una revisi√≥n de hardware con ZCD simplificado, mejor mec√°nica de placa para componentes de potencia y posible partici√≥n de control de dimming en microcontrolador dedicado.
\end{itemize}

\hrulefill

\section{Uso de herramientas de IA}

Se documenta el uso de IA seg√∫n requerimiento docente y archivo \texttt{listado de cosas hechas con IA.txt\}.

\subsection{Uso individual y conjunto}

\begin{itemize}
\item Ignacio:
\item asistencia para extraer estructura de memoria t√©cnica.
\item apoyo en revisi√≥n de README y documentaci√≥n.
\item apoyo en criterios de hardware y selecci√≥n de componentes.
\end{itemize}

\begin{itemize}
\item Francisco:
\item soporte para flujo de Itemis Create y diagramas de estado.
\item generaci√≥n de estructura inicial de documentaci√≥n t√©cnica de statechart (luego revisada manualmente).
\end{itemize}

\begin{itemize}
\item Uso com√∫n del equipo:
\item apoyo en redacci√≥n y ajuste de memoria t√©cnica.
\item apoyo extensivo en programaci√≥n STM32 (estructura, m√≥dulos y ajustes).
\item apoyo para redacci√≥n de descripciones de PR.
\end{itemize}


\hrulefill

\section{Bibliograf√≠a y referencias}

\begin{enumerate}
\item STMicroelectronics, \textit{UM1724 - STM32 Nucleo-64 boards user manual\}.
\item STMicroelectronics, \textit{MB1136 - Electrical Schematic - STM32 Nucleo-64 boards\}.
\item STMicroelectronics, \textit{STM32F103RB Datasheet\}.
\item ON Semiconductor, \textit{MOC3023M Datasheet\}.
\item STMicroelectronics, \textit{BTA06-600C Datasheet / notas de aplicaci√≥n TRIAC\}.
\item Repositorio del proyecto: \texttt{https://github.com/Embebidos-Fran-Marcos-Nacho/tdse-tf\textbackslash{}\_1-2\}.
\end{enumerate}

Referencias internas del repositorio:
\begin{itemize}
\item \texttt{README.md\}
\item \texttt{Informe\textbackslash{}\_de\textbackslash{}\_Avances.md\}
\item \texttt{Seguimiento.md\}
\item \texttt{Diagrama de Harel/STATECHART\textbackslash{}\_EXPLANATION.md\}
\item \texttt{Memoria t√©cnica/cosas e imagenes para memoria t√©cnica - hardware/*\}
\item \texttt{listado de cosas hechas con IA.txt\}
\end{itemize}

\hrulefill

\textbf{Fin de la Memoria T√©cnica\}
Autores: Ignacio Ezequiel Cavicchioli, Francisco Javier Moya
Fecha de edici√≥n: 18 de febrero de 2026
\end{document}
